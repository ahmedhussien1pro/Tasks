<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Tasks & Appointments Manager</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <style>
      @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
      body {
        font-family: 'Inter', sans-serif;
      }
      :root {
        /* --bg-primary: #1a1a1a;
        --bg-secondary: #2d2d2d;
        --bg-card: #242424; */
        --text-primary: #1a1a1a;
        /* --text-secondary: #b0b0b0;
        --border-color: #404040; */
      }
      .dark {
        --bg-primary: #1a1a1a;
        --bg-secondary: #2d2d2d;
        --bg-card: #242424;
        --text-primary: #ffffff;
        --text-secondary: #b0b0b0;
        --border-color: #404040;
      }
      .dark body {
        background-color: #1a1a1a;
      }
      .dark .card-bg {
        background-color: var(--bg-card);
        border-color: var(--border-color);
      }
      /* .dark .text-gray-800 {
        color: var(--text-primary);
      }
      .dark .text-gray-600 {
        color: var(--text-secondary);
      }
      .dark .text-gray-400 {
        color: #808080;
      } */
      .dark .bg-white {
        background-color: var(--bg-secondary);
      }
      .dark .border-gray-200 {
        border-color: var(--border-color);
      }
      .dark input,
      .dark textarea,
      .dark select {
        background-color: var(--bg-card);
        color: var(--text-primary);
        border-color: var(--border-color);
      }
      .dark input::placeholder,
      .dark textarea::placeholder {
        color: #808080;
      }
    </style>
  </head>
  <body
    class="bg-gray-50 min-h-screen p-2 sm:p-4 transition-colors duration-300">
    <div class="max-w-4xl mx-auto">
      <div
        class="card-bg bg-white rounded-2xl shadow-xl p-4 sm:p-6 mb-4 sm:mb-6">
        <!-- Header -->
        <div class="flex items-center justify-between mb-6">
          <h1
            class="text-2xl sm:text-3xl font-bold text-blue-600 flex items-center gap-2">
            <i class="fas fa-tasks"></i>
            <span class="hidden sm:inline">Tasks & Appointments Manager</span>
            <span class="sm:hidden">Tasks</span>
          </h1>
          <button
            onclick="toggleDarkMode()"
            class="p-3 rounded-lg bg-blue-100 dark:bg-blue-900 hover:bg-blue-200 dark:hover:bg-blue-800 transition">
            <i
              id="themeIcon"
              class="fas fa-moon text-blue-700 dark:text-yellow-300"></i>
          </button>
        </div>

        <!-- Add Task Form -->
        <div class="p-4 sm:p-6 rounded-xl mb-4 sm:mb-6">
          <h2
            class="text-lg sm:text-xl font-bold text-blue-600 mb-4 flex items-center gap-2">
            <i class="fas fa-plus-circle"></i>
            <span>Add New Task</span>
          </h2>
          <div class="space-y-3 sm:space-y-4">
            <input
              type="text"
              id="taskTitle"
              placeholder="Task Title"
              class="w-full px-3 sm:px-4 py-2 sm:py-3 border-2 border-blue-200 dark:border-blue-800 rounded-lg focus:outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-300 transition text-sm sm:text-base" />
            <textarea
              id="taskDesc"
              placeholder="Task Description (optional)"
              rows="2"
              class="w-full px-3 sm:px-4 py-2 sm:py-3 border-2 border-blue-200 dark:border-blue-800 rounded-lg focus:outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-300 transition text-sm sm:text-base"></textarea>
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 sm:gap-4">
              <input
                type="datetime-local"
                id="taskDeadline"
                class="w-full px-3 sm:px-4 py-2 sm:py-3 border-2 border-blue-200 dark:border-blue-800 rounded-lg focus:outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-300 transition text-sm sm:text-base" />
              <select
                id="taskPriority"
                class="w-full px-3 sm:px-4 py-2 sm:py-3 border-2 border-blue-200 dark:border-blue-800 rounded-lg focus:outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-300 transition text-sm sm:text-base">
                <option value="low">Low Priority</option>
                <option value="medium" selected>Medium Priority</option>
                <option value="high">High Priority</option>
              </select>
            </div>
            <button
              onclick="addTask()"
              class="w-full bg-blue-600 text-white py-2 sm:py-3 rounded-lg font-bold hover:bg-blue-700 transition transform hover:scale-105 shadow-lg text-sm sm:text-base">
              <i class="fas fa-plus mr-2"></i>
              <span id="submitBtnText">Add Task</span>
            </button>
          </div>
        </div>

        <!-- Filter Buttons -->
        <div class="flex flex-wrap gap-2 mb-4 sm:mb-6">
          <button
            onclick="filterTasks('all')"
            class="filter-btn active px-3 sm:px-4 py-2 rounded-lg font-semibold transition text-xs sm:text-sm">
            <i class="fas fa-list mr-1"></i>All
          </button>
          <button
            onclick="filterTasks('active')"
            class="filter-btn px-3 sm:px-4 py-2 rounded-lg font-semibold transition text-xs sm:text-sm">
            <i class="fas fa-clock mr-1"></i>Active
          </button>
          <button
            onclick="filterTasks('completed')"
            class="filter-btn px-3 sm:px-4 py-2 rounded-lg font-semibold transition text-xs sm:text-sm">
            <i class="fas fa-check-circle mr-1"></i>Completed
          </button>
          <button
            onclick="filterTasks('urgent')"
            class="filter-btn px-3 sm:px-4 py-2 rounded-lg font-semibold transition text-xs sm:text-sm">
            <i class="fas fa-exclamation-triangle mr-1"></i>Urgent
          </button>
        </div>

        <!-- Tasks Container -->
        <div id="tasksContainer" class="space-y-3 sm:space-y-4"></div>
      </div>
    </div>

    <script>
      let tasks = [];
      let currentFilter = 'all';
      let editingTaskId = null;
      let API_BASE_URL = 'https://task-manger-kappa-ecru.vercel.app/api';

      // Dark mode
      function toggleDarkMode() {
        document.documentElement.classList.toggle('dark');
        const isDark = document.documentElement.classList.contains('dark');
        localStorage.setItem('darkMode', isDark);
        document.getElementById('themeIcon').className = isDark
          ? 'fas fa-sun text-yellow-300'
          : 'fas fa-moon text-blue-700';
      }

      if (localStorage.getItem('darkMode') === 'true') {
        document.documentElement.classList.add('dark');
        document.getElementById('themeIcon').className =
          'fas fa-sun text-yellow-300';
      }

      // Change API URL
      function changeApiUrl() {
        const newUrl = document.getElementById('apiUrl').value.trim();
        if (newUrl) {
          API_BASE_URL = newUrl;
          localStorage.setItem('apiUrl', newUrl);
          alert('API URL updated successfully');
          loadTasks();
        }
      }

      // Load saved API URL
      const savedApiUrl = localStorage.getItem('apiUrl');
      if (savedApiUrl) {
        API_BASE_URL = savedApiUrl;
        document.getElementById('apiUrl').value = savedApiUrl;
      }

      // API call wrapper
      async function apiCall(endpoint, options = {}) {
        try {
          const response = await fetch(`${API_BASE_URL}${endpoint}`, {
            ...options,
            headers: {
              'Content-Type': 'application/json',
              ...options.headers,
            },
          });

          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }

          return await response.json();
        } catch (error) {
          console.error('API Error:', error);
          throw error;
        }
      }

      // Load tasks
      async function loadTasks() {
        try {
          tasks = await apiCall('/tasks');
          renderTasks();
        } catch (error) {
          console.error('Failed to load tasks:', error);
          alert('Failed to load tasks - Check server connection');
        }
      }

      // Add or update task
      async function addTask() {
        const title = document.getElementById('taskTitle').value.trim();
        const desc = document.getElementById('taskDesc').value.trim();
        const deadline = document.getElementById('taskDeadline').value;
        const priority = document.getElementById('taskPriority').value;

        if (!title || !deadline) {
          alert('Please enter task title and deadline');
          return;
        }

        try {
          if (editingTaskId) {
            await apiCall(`/tasks/${editingTaskId}`, {
              method: 'PUT',
              body: JSON.stringify({ title, desc, deadline, priority }),
            });
            editingTaskId = null;
            document.getElementById('submitBtnText').textContent = 'Add Task';
          } else {
            await apiCall('/tasks', {
              method: 'POST',
              body: JSON.stringify({ title, desc, deadline, priority }),
            });
          }
          clearForm();
          loadTasks();
        } catch (error) {
          console.error('Operation failed:', error);
          alert('Operation failed - Please try again');
        }
      }

      function clearForm() {
        document.getElementById('taskTitle').value = '';
        document.getElementById('taskDesc').value = '';
        document.getElementById('taskDeadline').value = '';
        document.getElementById('taskPriority').value = 'medium';
        editingTaskId = null;
        document.getElementById('submitBtnText').textContent = 'Add Task';
      }

      function editTask(id) {
        const task = tasks.find((t) => t._id === id);
        document.getElementById('taskTitle').value = task.title;
        document.getElementById('taskDesc').value = task.desc || '';
        document.getElementById('taskDeadline').value = new Date(task.deadline)
          .toISOString()
          .slice(0, 16);
        document.getElementById('taskPriority').value = task.priority;
        editingTaskId = id;
        document.getElementById('submitBtnText').textContent = 'Update Task';
        window.scrollTo({ top: 0, behavior: 'smooth' });
      }

      async function deleteTask(id) {
        if (confirm('Are you sure you want to delete this task?')) {
          try {
            await apiCall(`/tasks/${id}`, { method: 'DELETE' });
            loadTasks();
          } catch (error) {
            console.error('Delete failed:', error);
            alert('Delete failed - Please try again');
          }
        }
      }

      async function toggleComplete(id) {
        try {
          await apiCall(`/tasks/${id}/toggle`, { method: 'PATCH' });
          loadTasks();
        } catch (error) {
          console.error('Failed to update status:', error);
          alert('Failed to update status - Please try again');
        }
      }

      function getTimeRemaining(deadline) {
        const now = new Date();
        const end = new Date(deadline);
        const diff = end - now;

        if (diff < 0)
          return { text: 'Expired', class: 'expired', urgent: true };

        const days = Math.floor(diff / (1000 * 60 * 60 * 24));
        const hours = Math.floor(
          (diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60)
        );
        const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));

        let text = '';
        let urgent = false;
        let className = 'normal';

        if (days > 7) {
          text = `${days} days`;
          className = 'safe';
        } else if (days > 2) {
          text = `${days} days`;
          className = 'warning';
        } else if (days >= 1) {
          text = `${days}d ${hours}h`;
          className = 'warning';
          urgent = true;
        } else if (hours > 3) {
          text = `${hours} hours`;
          className = 'danger';
          urgent = true;
        } else {
          text = `${hours}h ${minutes}m`;
          className = 'critical';
          urgent = true;
        }

        return { text, class: className, urgent };
      }

      function filterTasks(filter) {
        currentFilter = filter;
        document.querySelectorAll('.filter-btn').forEach((btn) => {
          btn.classList.remove('active');
        });
        event.target.closest('.filter-btn').classList.add('active');
        renderTasks();
      }

      function renderTasks() {
        const container = document.getElementById('tasksContainer');
        let filteredTasks = [...tasks];

        if (currentFilter === 'active') {
          filteredTasks = filteredTasks.filter((t) => !t.completed);
        } else if (currentFilter === 'completed') {
          filteredTasks = filteredTasks.filter((t) => t.completed);
        } else if (currentFilter === 'urgent') {
          filteredTasks = filteredTasks.filter((t) => {
            const timeInfo = getTimeRemaining(t.deadline);
            return !t.completed && timeInfo.urgent;
          });
        }

        filteredTasks.sort(
          (a, b) => new Date(a.deadline) - new Date(b.deadline)
        );

        if (filteredTasks.length === 0) {
          container.innerHTML = `
            <div class="text-center py-12 text-gray-400 dark:text-gray-500">
              <i class="fas fa-inbox text-4xl sm:text-6xl mb-4"></i>
              <p class="text-lg sm:text-xl">No tasks available</p>
            </div>
          `;
          return;
        }

        container.innerHTML = filteredTasks
          .map((task) => {
            const timeInfo = getTimeRemaining(task.deadline);
            const priorityColors = {
              low: 'bg-green-100 text-green-700 dark:bg-green-900 dark:text-green-300',
              medium:
                'bg-yellow-100 text-yellow-700 dark:bg-yellow-900 dark:text-yellow-300',
              high: 'bg-red-100 text-red-700 dark:bg-red-900 dark:text-red-300',
            };
            const timeColors = {
              safe: 'bg-green-100 text-green-700 dark:bg-green-900 dark:text-green-300',
              normal:
                'bg-blue-100 text-blue-700 dark:bg-blue-900 dark:text-blue-300',
              warning:
                'bg-yellow-100 text-yellow-700 dark:bg-yellow-900 dark:text-yellow-300',
              danger:
                'bg-orange-100 text-orange-700 dark:bg-orange-900 dark:text-orange-300',
              critical:
                'bg-red-100 text-red-700 dark:bg-red-900 dark:text-red-300 animate-pulse',
              expired:
                'bg-gray-300 text-gray-700 dark:bg-gray-700 dark:text-gray-300',
            };

            return `
              <div class="card-bg bg-white border-2 ${
                task.completed
                  ? 'border-green-200 dark:border-green-800'
                  : 'border-gray-200'
              } rounded-xl p-3 sm:p-5 hover:shadow-lg transition ${
              task.completed ? 'opacity-60' : ''
            }">
                <div class="flex items-start justify-between mb-3">
                  <div class="flex items-start gap-2 sm:gap-3 flex-1">
                    <input type="checkbox" ${task.completed ? 'checked' : ''} 
                           onclick="toggleComplete('${task._id}')"
                           class="w-4 h-4 sm:w-5 sm:h-5 mt-1 cursor-pointer">
                    <div class="flex-1 min-w-0">
                      <h3 class="text-base sm:text-xl font-bold ${
                        task.completed
                          ? 'line-through text-gray-400 dark:text-blue-600'
                          : 'text-gray-800 dark:text-blue-600'
                      } break-words">
                        ${task.title}
                      </h3>
                      ${
                        task.desc
                          ? `<p class="text-sm sm:text-base text-gray-600 dark:text-gray-400 mt-1 break-words">${task.desc}</p>`
                          : ''
                      }
                    </div>
                  </div>
                  <div class="flex gap-1 sm:gap-2 flex-shrink-0">
                    <button onclick="editTask('${task._id}')" 
                            class="text-blue-500 hover:text-blue-700 dark:text-blue-400 dark:hover:text-blue-300 p-1 sm:p-2">
                      <i class="fas fa-edit text-sm sm:text-base"></i>
                    </button>
                    <button onclick="deleteTask('${task._id}')" 
                            class="text-red-500 hover:text-red-700 dark:text-red-400 dark:hover:text-red-300 p-1 sm:p-2">
                      <i class="fas fa-trash text-sm sm:text-base"></i>
                    </button>
                  </div>
                </div>
                <div class="flex flex-wrap gap-2 mt-3">
                  <span class="px-2 sm:px-3 py-1 rounded-full text-xs sm:text-sm font-semibold ${
                    priorityColors[task.priority]
                  }">
                    ${
                      task.priority === 'high'
                        ? 'High'
                        : task.priority === 'medium'
                        ? 'Medium'
                        : 'Low'
                    }
                  </span>
                  <span class="px-2 sm:px-3 py-1 rounded-full text-xs sm:text-sm font-semibold ${
                    timeColors[timeInfo.class]
                  }">
                    <i class="fas fa-clock mr-1"></i>${timeInfo.text}
                  </span>
                  ${
                    timeInfo.urgent && !task.completed
                      ? '<span class="px-2 sm:px-3 py-1 rounded-full text-xs sm:text-sm font-semibold bg-red-500 text-white"><i class="fas fa-exclamation-triangle mr-1"></i>Urgent</span>'
                      : ''
                  }
                </div>
                <div class="text-xs text-gray-400 dark:text-gray-500 mt-2">
                  <i class="fas fa-calendar mr-1"></i>${new Date(
                    task.deadline
                  ).toLocaleString('en-US')}
                </div>
              </div>
            `;
          })
          .join('');
      }

      // Auto-refresh every 30 seconds
      setInterval(loadTasks, 30000);

      // Initialize
      loadTasks();

      // Filter buttons style
      const style = document.createElement('style');
      style.textContent = `
        .filter-btn {
          background-color: #e0e7ff;
          color: #3730a3;
        }
        .dark .filter-btn {
          background-color: #312e81;
          color: #c7d2fe;
        }
        .filter-btn:hover {
          background-color: #c7d2fe;
          transform: translateY(-2px);
          box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
        }
        .dark .filter-btn:hover {
          background-color: #4338ca;
          box-shadow: 0 4px 12px rgba(99, 102, 241, 0.5);
        }
        .filter-btn.active {
          background-color: #4f46e5;
          color: white;
          box-shadow: 0 6px 20px rgba(79, 70, 229, 0.4);
        }
      `;
      document.head.appendChild(style);
    </script>
  </body>
</html>
